<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Budget Tracker (Realtime)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);color:#333;min-height:100vh;padding:15px;display:flex;flex-direction:column;align-items:center}
    .container{width:100%;max-width:1000px}
    header{text-align:center;margin-bottom:20px;padding:15px;color:white;width:100%}
    header h1{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
    header p{font-size:1rem;opacity:.9}
    .app-container{display:grid;grid-template-columns:1fr;gap:15px;width:100%}
    @media (min-width:768px){.app-container{grid-template-columns:1fr 1fr} header h1{font-size:2.5rem} header p{font-size:1.2rem}}
    .card{background:white;border-radius:12px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .card-title{font-size:1.3rem;margin-bottom:15px;color:#2575fc;display:flex;align-items:center;justify-content:space-between}
    .card-title i{margin-right:10px}
    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:5px;font-weight:500;font-size:.9rem}
    input,select,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:1rem}
    button{background:#2575fc;color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;transition:background .3s;width:100%;margin-top:5px}
    button:hover{background:#1c64e0}
    .summary-card{background:linear-gradient(135deg,#36d1dc 0%,#5b86e5 100%);color:white}
    .summary-item{display:flex;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,.3)}
    .summary-item:last-child{border-bottom:none;font-weight:bold;font-size:1.1rem}
    .transaction-list{max-height:300px;overflow-y:auto}
    .transaction-item{display:flex;justify-content:space-between;padding:10px 8px;border-bottom:1px solid #eee;font-size:.9rem}
    .transaction-item:last-child{border-bottom:none}
    .income{color:#2ecc71}
    .expense{color:#e74c3c}
    .transaction-title{display:flex;align-items:center}
    .transaction-title i{margin-right:8px;font-size:.9rem}
    .actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:15px}
    @media (min-width:480px){.actions{grid-template-columns:1fr 1fr}}
    .btn-secondary{background:#6c757d}.btn-secondary:hover{background:#5a6268}
    .btn-danger{background:#e74c3c}.btn-danger:hover{background:#c0392b}
    .btn-success{background:#2ecc71}.btn-success:hover{background:#27ae60}
    .notification{position:fixed;top:20px;right:20px;padding:12px 20px;background:#2ecc71;color:white;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.2);transform:translateX(100%);transition:transform .3s;z-index:1000}
    .notification.show{transform:translateX(0)}
    .tabs{display:flex;margin-bottom:15px;background:#f8f9fa;border-radius:8px;overflow:hidden}
    .tab{flex:1;padding:10px;text-align:center;cursor:pointer;transition:background .3s;font-size:.9rem}
    .tab.active{background:#2575fc;color:white;font-weight:bold}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .mobile-menu{display:none}
    .category-badges{display:grid;grid-template-columns:1fr;gap:10px;margin-top:15px}
    @media (min-width:480px){.category-badges{grid-template-columns:1fr 1fr}}
    .category-badge{background:#f8f9fa;border-radius:8px;padding:12px;display:flex;flex-direction:column}
    .category-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .category-name{font-weight:bold}
    .category-amount{font-size:.9rem}
    .progress-bar{height:10px;background:#e9ecef;border-radius:5px;overflow:hidden}
    .progress{height:100%;border-radius:5px}
    .progress-safe{background:#2ecc71}
    .progress-warning{background:#f39c12}
    .progress-danger{background:#e74c3c}
    .category-budget{display:flex;justify-content:space-between;margin-top:5px;font-size:.8rem;color:#6c757d}
    .add-category-btn{background:transparent;color:#2575fc;border:1px dashed #2575fc;padding:8px;margin-top:10px}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
    .modal-content{background:white;border-radius:12px;padding:20px;width:90%;max-width:400px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .close-modal{background:none;border:none;font-size:1.5rem;color:#6c757d;width:auto}
    /* Hide app when signed out */
    .signed-out .app-container{display:none}
  </style>
</head>
<body class="signed-out">
  <div class="container">
    <header>
      <h1><i class="fas fa-wallet"></i> Budget Tracker</h1>
      <p>Realtime for you + your partner (Firebase)</p>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="transactions">Transactions</div>
      <div class="tab" data-tab="summary">Summary</div>
      <div class="tab" data-tab="categories">Categories</div>
      <div class="tab" data-tab="manage">Manage</div>
    </div>

    <div class="app-container">
      <!-- Transactions -->
      <div class="card tab-content active" id="transactions-tab">
        <h2 class="card-title"><i class="fas fa-plus-circle"></i> Add Transaction</h2>
        <form id="transaction-form">
          <div class="form-group">
            <label for="type">Type</label>
            <select id="type" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="form-group">
            <label for="category">Category</label>
            <select id="category" required>
              <option value="">Select a category</option>
            </select>
          </div>
          <div class="form-group">
            <label for="amount">Amount ($)</label>
            <input type="number" id="amount" placeholder="Enter amount" required min="0" step="0.01">
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" required>
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" placeholder="Enter description">
          </div>
          <button type="submit">Add Transaction</button>
        </form>
      </div>

      <!-- Summary -->
      <div class="card summary-card tab-content" id="summary-tab">
        <h2 class="card-title"><i class="fas fa-chart-pie"></i> Budget Summary</h2>
        <div class="summary-item"><span>Total Income:</span><span id="total-income">$0.00</span></div>
        <div class="summary-item"><span>Total Expenses:</span><span id="total-expenses">$0.00</span></div>
        <div class="summary-item"><span>Remaining Budget:</span><span id="remaining-budget">$0.00</span></div>
      </div>

      <!-- Categories -->
      <div class="card tab-content" id="categories-tab">
        <h2 class="card-title">
          <span><i class="fas fa-tags"></i> Categories</span>
          <button class="add-category-btn" id="add-category-btn"><i class="fas fa-plus"></i> Add New</button>
        </h2>
        <div class="category-badges" id="category-badges"></div>
      </div>

      <!-- Manage -->
      <div class="card tab-content" id="manage-tab">
        <h2 class="card-title"><i class="fas fa-cog"></i> Manage</h2>
        <p>Shared space ID (give this to your partner): <b id="household-label"></b></p>
        <div class="actions">
          <button id="signin-btn" class="btn-success"><i class="fa-solid fa-right-to-bracket"></i> Sign in with Email</button>
          <button id="signout-btn" class="btn-secondary"><i class="fa-solid fa-right-from-bracket"></i> Sign out</button>
          <button id="switch-household-btn" class="btn-secondary"><i class="fas fa-people-arrows"></i> Change Household</button>
          <button id="clear-btn" class="btn-danger"><i class="fas fa-trash"></i> Clear All (danger)</button>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="card">
        <h2 class="card-title"><i class="fas fa-list"></i> Recent Transactions</h2>
        <div class="transaction-list" id="transaction-list">
          <div class="transaction-item">
            <div class="transaction-title">No transactions yet</div>
            <div class="transaction-amount">$0.00</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Category</h2>
        <button class="close-modal" data-close="#category-modal" aria-label="Close">&times;</button>
      </div>
      <form id="category-form">
        <div class="form-group">
          <label for="category-name">Category Name</label>
          <input type="text" id="category-name" required>
        </div>
        <div class="form-group">
          <label for="category-type">Type</label>
          <select id="category-type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group">
          <label for="category-budget">Monthly Budget (expense) / Target (income)</label>
          <input type="number" id="category-budget" min="0" step="0.01">
        </div>
        <button type="submit" class="btn-success">Save Category</button>
      </form>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal" id="category-edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Category</h2>
        <button class="close-modal" data-close="#category-edit-modal" aria-label="Close">&times;</button>
      </div>
      <form id="category-edit-form">
        <input type="hidden" id="edit-category-id">
        <input type="hidden" id="edit-old-name">
        <input type="hidden" id="edit-old-type">
        <div class="form-group">
          <label for="edit-category-name">Name</label>
          <input type="text" id="edit-category-name" required>
        </div>
        <div class="form-group">
          <label for="edit-category-type">Type</label>
          <select id="edit-category-type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-category-budget">Monthly Amount / Budget</label>
          <input type="number" id="edit-category-budget" min="0" step="0.01">
        </div>
        <button type="submit" class="btn-success">Save</button>
      </form>
    </div>
  </div>

  <!-- Category Detail Modal -->
  <div class="modal" id="category-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="detail-title">Category Details</h2>
        <button class="close-modal" data-close="#category-detail-modal" aria-label="Close">&times;</button>
      </div>
      <div id="detail-summary" style="margin-bottom:10px;"></div>
      <div id="detail-items"></div>
    </div>
  </div>

  <!-- Household Switcher Modal -->
  <div class="modal" id="household-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Change Household</h2>
        <button class="close-modal" data-close="#household-modal" aria-label="Close">&times;</button>
      </div>
      <form id="household-form">
        <div class="form-group">
          <label for="household-input">Enter a shared ID (e.g., <code>our-home-01</code>)</label>
          <input type="text" id="household-input" placeholder="my-family-01" required>
        </div>
        <button type="submit" class="btn-success">Switch</button>
      </form>
    </div>
  </div>

  <!-- Email Sign-in Modal -->
  <div class="modal" id="email-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sign in via Email Link</h2>
        <button class="close-modal" data-close="#email-modal" aria-label="Close">&times;</button>
      </div>
      <form id="email-form">
        <div class="form-group">
          <label for="email-input">Your email</label>
          <input type="email" id="email-input" placeholder="you@example.com" required>
        </div>
        <button type="submit" class="btn-success">Send Sign-in Link</button>
        <p style="margin-top:10px;color:#6c757d;font-size:.9rem;">
          We’ll email you a secure link. Open it on this device to finish signing in.
        </p>
      </form>
    </div>
  </div>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      isSignInWithEmailLink,
      sendSignInLinkToEmail,
      signInWithEmailLink,
      onAuthStateChanged,
      signOut,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, getDoc, getDocs, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔧 Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBrBqhylpvDh8j9c0eddrBuGVt3YEcU1Cs",
      authDomain: "budget-beabb.firebaseapp.com",
      projectId: "budget-beabb",
      appId: "1:222008362126:web:70db15c87c13657d16b5df"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Persist session in this browser
    await setPersistence(auth, browserLocalPersistence);

    // Complete email-link sign-in if arriving from the email
    try {
      if (isSignInWithEmailLink(auth, window.location.href)) {
        let email = window.localStorage.getItem('pendingEmail');
        if (!email) email = window.prompt('Confirm your email to finish sign-in');
        if (email) {
          await signInWithEmailLink(auth, email, window.location.href);
          window.localStorage.removeItem('pendingEmail');
          // Clean URL
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    } catch (err) {
      console.error('Email-link sign-in failed:', err);
      window.addEventListener('DOMContentLoaded', ()=>{
        const n = document.getElementById('notification');
        if (n) { n.textContent = `Auth error: ${err.code || ''} ${err.message || err}`; n.classList.add('show'); }
      });
    }

    // Ensure a household doc exists
    async function ensureHouseholdDoc(householdId){
      const ref = doc(db, "households", householdId);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { createdAt: Date.now() });
      return ref;
    }
    // Build collection handles for a household
    async function getHouseholdHandles(householdId){
      const householdRef = await ensureHouseholdDoc(householdId);
      return {
        householdId,
        householdRef,
        categoriesCol: collection(householdRef, "categories"),
        transactionsCol: collection(householdRef, "transactions"),
      };
    }

    // Expose small wrappers for non-module script
    window.firebaseAuth = {
      sendSignInLink: (email, settings) => sendSignInLinkToEmail(auth, email, settings),
      signOut: () => signOut(auth),
      onAuthStateChanged: (cb) => onAuthStateChanged(auth, cb),
      currentUser: () => auth.currentUser
    };

    // Expose Firestore helpers + household handles
    window.$rt = {
      db, getHouseholdHandles,
      addDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy,
      getDocs, where, writeBatch
    };

    // Default household
    window.__DEFAULT_HOUSEHOLD__ = "our-home-01";
  </script>

  <!-- App logic -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const hhLabel = document.getElementById('household-label');
    const typeSelect = document.getElementById('type');
    const categorySelect = document.getElementById('category');
    const dateEl = document.getElementById('date'); if (dateEl) dateEl.valueAsDate = new Date();

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    function activateTab(tabId) {
      tabContents.forEach(c => c.classList.remove('active'));
      const targetTab = document.getElementById(`${tabId}-tab`);
      if (targetTab) targetTab.classList.add('active');
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-tab') === tabId));
    }
    tabs.forEach(tab => tab.addEventListener('click', () => activateTab(tab.getAttribute('data-tab'))));

    function openModal(el){ if (el) el.style.display='flex'; }
    function closeModal(el){ if (el) el.style.display='none'; }
    document.querySelectorAll('.close-modal').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-close');
        if (target) closeModal(document.querySelector(target));
        else closeModal(btn.closest('.modal'));
      });
    });
    window.addEventListener('click', (e) => {
      document.querySelectorAll('.modal').forEach(m => { if (e.target === m) m.style.display = 'none'; });
    });

    function showNotification(message){
      const n = document.getElementById('notification');
      if (!n) return;
      n.textContent = message;
      n.classList.add('show');
      setTimeout(()=> n.classList.remove('show'), 3000);
    }

    // ====== STATE ======
    let categories = [];
    let transactions = [];
    let handles = null;
    let unsubCats = null;
    let unsubTx = null;

    // Helpers exposed by the module script
    const {
      addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy,
      getDocs, where, writeBatch, getHouseholdHandles
    } = window.$rt || {};

    // ====== HOUSEHOLD BINDING ======
    async function bindHousehold(householdId){
      // Clean previous listeners
      if (typeof unsubCats === 'function') { unsubCats(); unsubCats = null; }
      if (typeof unsubTx === 'function') { unsubTx(); unsubTx = null; }

      // Reset UI
      categories = [];
      transactions = [];
      renderTransactions();
      renderCategoryBadges();
      updateSummary();

      // Build refs
      handles = await getHouseholdHandles(householdId);
      if (hhLabel) hhLabel.textContent = handles.householdId;

      // Listen to categories
      unsubCats = onSnapshot(handles.categoriesCol, (snap) => {
        categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rebuildCategoryOptions();
        renderCategoryBadges();
      });

      // Listen to transactions (newest first)
      unsubTx = onSnapshot(query(handles.transactionsCol, orderBy('date','desc')), (snap) => {
        transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTransactions();
        updateSummary();
        renderCategoryBadges();
      });
    }

    // ====== AUTH GATE (GUARDED) ======
    const initAuthListener = () => {
      if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChanged === 'function') {
        window.firebaseAuth.onAuthStateChanged(async (user)=>{
          if (user) {
            await bindHousehold(window.__DEFAULT_HOUSEHOLD__ || 'our-home-01');
            document.body.classList.remove('signed-out');
            showNotification(`Signed in as ${user.email || 'user'}`);
          } else {
            if (typeof unsubCats === 'function') unsubCats();
            if (typeof unsubTx === 'function') unsubTx();
            categories = []; transactions = [];
            renderTransactions(); renderCategoryBadges(); updateSummary();
            document.body.classList.add('signed-out');
            // Auto-open sign-in modal (uncomment if you want it to pop immediately)
            // openModal(document.getElementById('email-modal'));
          }
        });
      } else {
        console.error('Auth not ready — check firebaseConfig, imports, and Authorized domains.');
        // Retry (prevents the “line ~796” crash if modules lag)
        setTimeout(initAuthListener, 1500);
      }
    };
    initAuthListener();

    // ====== UI BUILDERS ======
    function rebuildCategoryOptions() {
      while (categorySelect.options.length > 1) categorySelect.remove(1);
      const currentType = typeSelect.value;
      categories.forEach(c => {
        if (c.type === currentType) {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          categorySelect.appendChild(opt);
        }
      });
      if (categorySelect.value) {
        const still = [...categorySelect.options].some(o => o.value === categorySelect.value);
        if (!still) categorySelect.value = '';
      }
    }
    typeSelect.addEventListener('change', rebuildCategoryOptions);

    function renderCategoryBadges() {
      const wrap = document.getElementById('category-badges');
      if (!wrap) return;
      wrap.innerHTML = '';
      if (categories.length === 0) {
        wrap.innerHTML = '<p>No categories yet. Add one to get started.</p>';
        return;
      }
      categories.forEach((category) => {
        const sumForCat = transactions
          .filter(t => t.category === category.name && t.type === category.type)
          .reduce((s, t) => s + Number(t.amount || 0), 0);

        const hasBudget = typeof category.budget === 'number' && category.budget > 0;
        const percent = hasBudget ? Math.min(100, (sumForCat / category.budget) * 100) : 0;

        let progressClass = 'progress-safe';
        if (hasBudget) {
          if (percent > 75) progressClass = 'progress-danger';
          else if (percent > 50) progressClass = 'progress-warning';
        }

        const headerRight = hasBudget
          ? (category.type === 'expense'
              ? `$${sumForCat.toFixed(2)} / $${category.budget.toFixed(2)}`
              : `$${sumForCat.toFixed(2)} / target $${category.budget.toFixed(2)}`)
          : `$${sumForCat.toFixed(2)}`;

        const remainingText = hasBudget
          ? (category.type === 'expense'
              ? `$${(category.budget - sumForCat).toFixed(2)} left`
              : `$${(category.budget - sumForCat).toFixed(2)} to target`)
          : 'No limit set';

        const badge = document.createElement('div');
        badge.className = 'category-badge';
        badge.innerHTML = `
          <div class="category-header">
            <span class="category-name">${category.name} <small style="color:#6c757d;">(${category.type})</small></span>
            <span class="category-amount">${headerRight}</span>
          </div>
          <div class="progress-bar" ${hasBudget ? '' : 'style="opacity:.4;"'}>
            <div class="progress ${progressClass}" style="width:${hasBudget ? percent : 0}%"></div>
          </div>
          <div class="category-budget">
            <span>${hasBudget ? `${percent.toFixed(0)}%` : '—'}</span>
            <span>${remainingText}</span>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn-secondary btn-view" data-id="${category.id}" style="flex:1;">View items</button>
            <button class="btn-success btn-edit" data-id="${category.id}" style="flex:1;">Edit</button>
          </div>
        `;
        wrap.appendChild(badge);
      });

      // Wire buttons
      wrap.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-id')));
      });
      wrap.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', () => openDetailModal(btn.getAttribute('data-id')));
      });
    }

    function renderTransactions() {
      const list = document.getElementById('transaction-list');
      if (!list) return;
      if (transactions.length === 0) {
        list.innerHTML = `
          <div class="transaction-item">
            <div class="transaction-title">No transactions yet</div>
            <div class="transaction-amount">$0.00</div>
          </div>`;
        return;
      }
      const recent = transactions.slice(0,10);
      list.innerHTML = recent.map(t => `
        <div class="transaction-item">
          <div class="transaction-title">
            <i class="fas ${t.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}"></i>
            ${t.description || 'No description'}
            <small style="color:#6c757d;margin-left:8px;">(${t.date})</small>
          </div>
          <div class="${t.type==='income'?'income':'expense'}">
            ${t.type==='income'?'+':'-'}$${Number(t.amount||0).toFixed(2)}
          </div>
        </div>`).join('');
    }

    function updateSummary() {
      const totalIncome = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
      const totalExpenses = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
      const remaining = totalIncome - totalExpenses;
      document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
      document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
      const remainingEl = document.getElementById('remaining-budget');
      remainingEl.textContent = `$${remaining.toFixed(2)}`;
      remainingEl.style.color = remaining < 0 ? '#e74c3c' : '#2ecc71';
    }

    // ====== CATEGORY: ADD ======
    const categoryModal = document.getElementById('category-modal');
    document.getElementById('add-category-btn').addEventListener('click', ()=> openModal(categoryModal));
    document.getElementById('category-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const name   = document.getElementById('category-name').value.trim();
      const type   = document.getElementById('category-type').value;
      const budget = parseFloat(document.getElementById('category-budget').value) || 0;

      // Prevent duplicates
      const exists = categories.some(c => c.name.toLowerCase() === name.toLowerCase() && c.type === type);
      if (exists) { showNotification('Category already exists for this type.'); return; }

      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await addDoc(handles.categoriesCol, { name, type, budget });
        this.reset();
        closeModal(categoryModal);
        showNotification('Category added!');
      } catch (err) {
        console.error(err);
        showNotification(`Error saving category: ${err.code || ''} ${err.message || err}`);
      } finally {
        btn.disabled = false;
      }
    });

    // ====== CATEGORY: EDIT + CASCADE ======
    const editModal = document.getElementById('category-edit-modal');
    document.getElementById('category-edit-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const id = document.getElementById('edit-category-id').value;
      const oldName = document.getElementById('edit-old-name').value;
      const oldType = document.getElementById('edit-old-type').value;

      const newName = document.getElementById('edit-category-name').value.trim();
      const newType = document.getElementById('edit-category-type').value;
      const newBudget = parseFloat(document.getElementById('edit-category-budget').value) || 0;

      // Prevent duplicates after rename
      const dup = categories.some(c => c.id !== id && c.name.toLowerCase() === newName.toLowerCase() && c.type === newType);
      if (dup) { showNotification('Another category with this name & type already exists.'); return; }

      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await updateDoc(doc(handles.categoriesCol, id), { name: newName, type: newType, budget: newBudget });

        const changed = (oldName !== newName) || (oldType !== newType);
        if (changed) {
          const q = window.$rt.query(
            handles.transactionsCol,
            window.$rt.where('category', '==', oldName),
            window.$rt.where('type', '==', oldType)
          );
          const snap = await getDocs(q);
          if (!snap.empty) {
            const batch = writeBatch(window.$rt.db);
            snap.forEach(docSnap => batch.update(docSnap.ref, { category: newName, type: newType }));
            await batch.commit();
          }
        }
        closeModal(editModal);
        showNotification('Category updated!');
      } catch (err) {
        console.error(err);
        showNotification(`Error updating category: ${err.code || ''} ${err.message || err}`);
      } finally {
        btn.disabled = false;
      }
    });

    function openEditModal(id){
      const cat = categories.find(c => c.id === id);
      if (!cat) return;
      document.getElementById('edit-category-id').value = id;
      document.getElementById('edit-old-name').value = cat.name;
      document.getElementById('edit-old-type').value = cat.type;
      document.getElementById('edit-category-name').value = cat.name;
      document.getElementById('edit-category-type').value = cat.type;
      document.getElementById('edit-category-budget').value = cat.budget || 0;
      openModal(editModal);
    }

    // ====== CATEGORY: DETAIL ======
    const detailModal = document.getElementById('category-detail-modal');
    const detailTitle = document.getElementById('detail-title');
    const detailItems = document.getElementById('detail-items');
    const detailSummary = document.getElementById('detail-summary');

    function openDetailModal(id){
      const cat = categories.find(c => c.id === id);
      if (!cat) return;
      const items = transactions.filter(t => t.category === cat.name && t.type === cat.type);
      const total = items.reduce((s,t)=> s + Number(t.amount||0), 0);
      const budget = cat.budget || 0;

      detailTitle.textContent = `${cat.name} (${cat.type})`;
      detailSummary.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div><strong>Total ${cat.type === 'expense' ? 'spent' : 'received'}:</strong> $${total.toFixed(2)}</div>
          <div><strong>${cat.type === 'expense' ? 'Budget' : 'Target'}:</strong> ${budget > 0 ? '$'+budget.toFixed(2) : '—'}</div>
          ${budget > 0 ? `<div><strong>${cat.type === 'expense' ? 'Left' : 'To target'}:</strong> $${(budget - total).toFixed(2)}</div>` : ''}
        </div>
      `;
      if (items.length === 0) {
        detailItems.innerHTML = `<p style="margin-top:10px;">No ${cat.type} entries in this category yet.</p>`;
      } else {
        detailItems.innerHTML = items
          .sort((a,b)=> new Date(b.date) - new Date(a.date))
          .map(item => `
            <div class="transaction-item" style="padding-left:0;">
              <div class="transaction-title">
                <i class="fas ${item.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}"></i>
                ${item.description || 'No description'} <small style="color:#6c757d;margin-left:8px;">(${item.date})</small>
              </div>
              <div class="${item.type==='income'?'income':'expense'}">
                ${item.type==='income'?'+':'-'}$${Number(item.amount||0).toFixed(2)}
              </div>
            </div>
          `).join('');
      }
      openModal(detailModal);
    }

    // ====== TRANSACTION: ADD ======
    document.getElementById('transaction-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const selectedCategory = categorySelect.value;
      if (!selectedCategory) { showNotification('Please choose a category first.'); return; }
      const amountVal = parseFloat(document.getElementById('amount').value);
      if (!isFinite(amountVal) || amountVal < 0) { showNotification('Enter a valid amount (>= 0).'); return; }

      const transaction = {
        type: typeSelect.value,
        category: selectedCategory,
        amount: Number(amountVal.toFixed(2)),
        date: document.getElementById('date').value,
        description: (document.getElementById('description').value || 'No description').trim(),
        createdAt: Date.now()
      };
      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await addDoc(handles.transactionsCol, transaction);
        this.reset();
        if (dateEl) dateEl.valueAsDate = new Date();
        typeSelect.value = 'income';
        rebuildCategoryOptions();
        showNotification('Transaction added!');
      } catch (err) {
        console.error(err);
        showNotification(`Error adding transaction: ${err.code || ''} ${err.message || err}`);
      } finally {
        btn.disabled = false;
      }
    });

    // ====== CLEAR ALL (DANGER) ======
    document.getElementById('clear-btn').addEventListener('click', async function(){
      if (!confirm('Are you sure? This erases EVERYTHING for this household.')) return;
      try{
        const delCat = async () => {
          const ids = categories.map(c=>c.id);
          for (const id of ids) { await deleteDoc(doc(handles.categoriesCol, id)); }
        };
        const delTx = async () => {
          const ids = transactions.map(t=>t.id);
          for (const id of ids) { await deleteDoc(doc(handles.transactionsCol, id)); }
        };
        await delTx(); await delCat();
        showNotification('All data cleared for this household.');
      } catch(err){
        console.error(err);
        showNotification(`Error clearing data: ${err.code || ''} ${err.message || err}`);
      }
    });

    // ====== HOUSEHOLD SWITCHER ======
    const householdModal = document.getElementById('household-modal');
    document.getElementById('switch-household-btn').addEventListener('click', ()=> {
      const input = document.getElementById('household-input');
      if (input) input.value = handles?.householdId || '';
      openModal(householdModal);
    });
    document.getElementById('household-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const newId = (document.getElementById('household-input').value || '').trim();
      if (!newId) return;
      await bindHousehold(newId);
      closeModal(householdModal);
      showNotification(`Switched to: ${newId}`);
    });

    // ====== EMAIL LINK SIGN-IN UI ======
    const emailModal = document.getElementById('email-modal');
    document.getElementById('signin-btn').addEventListener('click', () => openModal(emailModal));
    document.getElementById('email-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = (document.getElementById('email-input').value || '').trim();
      if (!email) return;

      const actionCodeSettings = {
        url: window.location.origin + window.location.pathname,
        handleCodeInApp: true
        // dynamicLinkDomain: "YOUR_DYNAMIC_LINK_DOMAIN" // optional if configured
      };

      try{
        await window.firebaseAuth.sendSignInLink(email, actionCodeSettings);
        window.localStorage.setItem('pendingEmail', email);
        closeModal(emailModal);
        showNotification('Sign-in link sent! Check your email.');
      }catch(err){
        console.error(err);
        showNotification(`Error sending link: ${err.code || ''} ${err.message || err}`);
      }
    });

    document.getElementById('signout-btn').addEventListener('click', async ()=>{
      try{
        await window.firebaseAuth.signOut();
        showNotification('Signed out.');
      }catch(err){
        console.error(err);
        showNotification(`Error signing out: ${err.code || ''} ${err.message || err}`);
      }
    });

  });
  </script>

  <div class="notification" id="notification">Done!</div>
</body>
</html>

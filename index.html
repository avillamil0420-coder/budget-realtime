<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Budget Tracker (Realtime)</title>
  <link rel="icon" href="data:,"><!-- silence favicon 404 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    :root{--brand:#2575fc;--ok:#2ecc71;--warn:#f39c12;--bad:#e74c3c}
    body{background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);min-height:100vh;color:#1f2937;padding:12px;display:flex;flex-direction:column;align-items:center}
    .container{width:100%;max-width:960px}
    header{text-align:center;margin-bottom:14px;color:white}
    header h1{font-size:1.8rem;margin-bottom:6px;text-shadow:0 2px 10px rgba(0,0,0,.25)}
    header p{opacity:.95}
    .tabs{position:sticky;top:0;z-index:10;display:flex;background:#f8f9fa;border-radius:10px;overflow:hidden;margin-bottom:12px;box-shadow:0 3px 12px rgba(0,0,0,.08)}
    .tab{flex:1;padding:12px 10px;text-align:center;cursor:pointer;font-weight:600}
    .tab.active{background:var(--brand);color:white}
    .app-container{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:760px){.app-container{grid-template-columns:1fr 1fr} header h1{font-size:2.2rem}}
    .card{background:white;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .card-title{display:flex;align-items:center;justify-content:space-between;color:var(--brand);font-size:1.1rem;margin-bottom:12px}
    .form-group{margin-bottom:10px}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:.95rem}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:1rem;min-height:44px}
    button{background:var(--brand);color:white;border:none;padding:12px;border-radius:10px;cursor:pointer;font-weight:700;min-height:44px}
    button:hover{filter:brightness(.98)}
    .btn-secondary{background:#6c757d}
    .btn-danger{background:var(--bad)}
    .btn-success{background:var(--ok)}
    .summary-card{background:linear-gradient(135deg,#36d1dc 0%,#5b86e5 100%);color:white}
    .summary-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.35)}
    .summary-item:last-child{border-bottom:none}
    .transaction-list{max-height:360px;overflow-y:auto}
    .transaction-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;font-size:.95rem}
    .income{color:var(--ok)} .expense{color:var(--bad)}
    .category-badges{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:520px){.category-badges{grid-template-columns:1fr 1fr}}
    .category-badge{background:#f8f9fa;border-radius:12px;padding:12px}
    .category-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .progress-bar{height:10px;background:#e9ecef;border-radius:6px;overflow:hidden}
    .progress{height:100%}
    .progress-safe{background:var(--ok)} .progress-warning{background:var(--warn)} .progress-danger{background:var(--bad)}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:12px}
    .modal-content{background:white;border-radius:14px;padding:16px;width:100%;max-width:420px;max-height:90vh;overflow:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .close-modal{background:none;border:none;font-size:1.6rem;color:#6c757d}
    .notification{position:fixed;top:18px;right:18px;background:var(--ok);color:white;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);transform:translateX(140%);transition:transform .3s;z-index:1100}
    .notification.show{transform:translateX(0)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-wallet"></i> Budget Tracker</h1>
      <p>Open your invite link on any device. No sign-in prompts.</p>
    </header>

    <!-- Invite helper (only shown when no ?h=...) -->
    <div id="invite-helper" class="card" style="display:none">
      <h2 class="card-title"><i class="fa-solid fa-link"></i> Create a shared space</h2>
      <p>Tap the button to create a private invite link. Anyone with the link shares the same budget space.</p>
      <div style="display:grid;gap:10px;margin-top:10px;">
        <button id="create-link" class="btn-success"><i class="fa-solid fa-wand-magic-sparkles"></i> Create invite link</button>
        <input id="invite-url" readonly style="display:none"/>
        <button id="copy-link" class="btn-secondary" style="display:none"><i class="fa-solid fa-copy"></i> Copy link</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="transactions">Transactions</div>
      <div class="tab" data-tab="summary">Summary</div>
      <div class="tab" data-tab="categories">Categories</div>
      <div class="tab" data-tab="manage">Manage</div>
    </div>

    <div class="app-container">
      <!-- Transactions -->
      <div class="card tab-content active" id="transactions-tab">
        <h2 class="card-title"><span><i class="fas fa-plus-circle"></i> Add Transaction</span></h2>
        <form id="transaction-form">
          <div class="form-group">
            <label for="type">Type</label>
            <select id="type" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="form-group">
            <label for="category">Category</label>
            <select id="category" required>
              <option value="">Select a category</option>
            </select>
          </div>
          <div class="form-group">
            <label for="amount">Amount ($)</label>
            <input type="number" id="amount" min="0" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" required>
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" placeholder="Optional">
          </div>
          <button type="submit" class="btn-success">Add Transaction</button>
        </form>
      </div>

      <!-- Summary -->
      <div class="card summary-card tab-content" id="summary-tab">
        <h2 class="card-title"><i class="fas fa-chart-pie"></i> Budget Summary</h2>
        <div class="summary-item"><span>Total Income:</span><span id="total-income">$0.00</span></div>
        <div class="summary-item"><span>Total Expenses:</span><span id="total-expenses">$0.00</span></div>
        <div class="summary-item"><span>Remaining Budget:</span><span id="remaining-budget">$0.00</span></div>
        <div style="background:white;border-radius:12px;margin-top:12px;padding:12px;height:280px;">
          <canvas id="summary-chart"></canvas>
          <div id="summary-table" style="overflow-x:auto;margin-top:10px;"></div>
        </div>
      </div>

      <!-- Categories -->
      <div class="card tab-content" id="categories-tab">
        <h2 class="card-title">
          <span><i class="fas fa-tags"></i> Categories</span>
          <button class="add-category-btn" id="add-category-btn" style="width:auto"><i class="fas fa-plus"></i> Add New</button>
        </h2>
        <div class="category-badges" id="category-badges"></div>
      </div>

      <!-- Manage -->
      <div class="card tab-content" id="manage-tab">
        <h2 class="card-title"><i class="fas fa-cog"></i> Manage</h2>
        <p>Shared space ID: <b id="household-label"></b></p>
        <div class="actions" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
          <button id="switch-household-btn" class="btn-secondary"><i class="fas fa-people-arrows"></i> Change Household</button>
          <button id="clear-btn" class="btn-danger"><i class="fas fa-trash"></i> Clear All (danger)</button>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="card">
        <h2 class="card-title"><i class="fas fa-list"></i> Recent Transactions</h2>
        <div class="transaction-list" id="transaction-list">
          <div class="transaction-item"><div>No transactions yet</div><div>$0.00</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Category</h2>
        <button class="close-modal" data-close="#category-modal" aria-label="Close">&times;</button>
      </div>
      <form id="category-form">
        <div class="form-group"><label for="category-name">Category Name</label><input type="text" id="category-name" required></div>
        <div class="form-group">
          <label for="category-type">Type</label>
          <select id="category-type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group"><label for="category-budget">Monthly Budget (expense) / Target (income)</label><input type="number" id="category-budget" min="0" step="0.01"></div>
        <button type="submit" class="btn-success">Save Category</button>
      </form>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal" id="category-edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Category</h2>
        <button class="close-modal" data-close="#category-edit-modal" aria-label="Close">&times;</button>
      </div>
      <form id="category-edit-form">
        <input type="hidden" id="edit-category-id">
        <input type="hidden" id="edit-old-name">
        <input type="hidden" id="edit-old-type">
        <div class="form-group"><label for="edit-category-name">Name</label><input type="text" id="edit-category-name" required></div>
        <div class="form-group">
          <label for="edit-category-type">Type</label>
          <select id="edit-category-type" required>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="form-group"><label for="edit-category-budget">Monthly Amount / Budget</label><input type="number" id="edit-category-budget" min="0" step="0.01"></div>
        <button type="submit" class="btn-success">Save</button>
      </form>
    </div>
  </div>

  <!-- Category Detail Modal -->
  <div class="modal" id="category-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="detail-title">Category Details</h2>
        <button class="close-modal" data-close="#category-detail-modal" aria-label="Close">&times;</button>
      </div>
      <div id="detail-summary" style="margin-bottom:10px;"></div>
      <div id="detail-items"></div>
    </div>
  </div>

  <!-- Transaction Edit Modal -->
  <div class="modal" id="tx-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Transaction</h2>
        <button class="close-modal" data-close="#tx-modal" aria-label="Close">&times;</button>
      </div>
      <form id="tx-form">
        <input type="hidden" id="tx-id">
        <div class="form-group"><label for="tx-type">Type</label>
          <select id="tx-type" required><option value="income">Income</option><option value="expense">Expense</option></select>
        </div>
        <div class="form-group"><label for="tx-category">Category</label>
          <select id="tx-category" required><option value="">Select a category</option></select>
        </div>
        <div class="form-group"><label for="tx-amount">Amount ($)</label><input type="number" id="tx-amount" min="0" step="0.01" required></div>
        <div class="form-group"><label for="tx-date">Date</label><input type="date" id="tx-date" required></div>
        <div class="form-group"><label for="tx-desc">Description</label><input type="text" id="tx-desc" placeholder="Description"></div>
        <button type="submit" class="btn-success">Save</button>
        <button type="button" id="tx-delete" class="btn-danger" style="margin-top:8px;">Delete</button>
      </form>
    </div>
  </div>

  <!-- Household Switcher Modal -->
  <div class="modal" id="household-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Change Household</h2>
        <button class="close-modal" data-close="#household-modal" aria-label="Close">&times;</button>
      </div>
      <form id="household-form">
        <div class="form-group">
          <label for="household-input">Enter a shared ID (e.g., <code>hh_abc123…</code>)</label>
          <input type="text" id="household-input" placeholder="hh_..." required>
        </div>
        <button type="submit" class="btn-success">Switch</button>
      </form>
    </div>
  </div>

  <!-- Firebase (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, getDoc, getDocs, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyBrBqhylpvDh8j9c0eddrBuGVt3YEcU1Cs",
      authDomain: "budget-beabb.firebaseapp.com",
      projectId: "budget-beabb",
      appId: "1:222008362126:web:70db15c87c13657d16b5df"
    };

    // App & services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Expose minimal helpers
    window.$rt = {
      db,
      addDoc, setDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc, getDocs, where, writeBatch,
      getHouseholdHandles: async (householdId) => {
        const householdRef = doc(db, "households", householdId);
        const snap = await getDoc(householdRef);
        if (!snap.exists()) await setDoc(householdRef, { createdAt: Date.now() });
        return {
          householdId,
          householdRef,
          categoriesCol: collection(householdRef, "categories"),
          transactionsCol: collection(householdRef, "transactions"),
        };
      }
    };

    // Anonymous auth (silent)
    async function initAuth() {
      try { await setPersistence(auth, browserLocalPersistence); } catch(e){}
      if (!auth.currentUser) {
        try { await signInAnonymously(auth); } catch (e) { console.error("Anonymous sign-in failed", e); }
      }
    }
    await initAuth();
    window.firebaseAuth = { onAuthStateChanged: (cb)=>onAuthStateChanged(auth, cb), user: ()=>auth.currentUser };
  </script>

  <!-- App logic -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const BASE_URL = "https://avillamil0420-coder.github.io/budget-realtime/";
    const qs = new URLSearchParams(location.search);
    let invitedHousehold = qs.get('h') || '';

    const inviteHelper = document.getElementById('invite-helper');
    const createBtn = document.getElementById('create-link');
    const inviteUrl = document.getElementById('invite-url');
    const copyBtn = document.getElementById('copy-link');

    // Invite link helper
    function randomId(len=22){
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let s='hh_';
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function showInviteCreator(){
      inviteHelper.style.display = 'block';
      createBtn.onclick = async ()=>{
        const hid = randomId(22);
        const url = `${BASE_URL}?h=${encodeURIComponent(hid)}`;
        inviteUrl.value = url; inviteUrl.style.display='block'; copyBtn.style.display='block';
        copyBtn.onclick = async ()=> {
          await navigator.clipboard.writeText(url);
          showNotification('Invite link copied!');
        };
      };
    }

    const hhLabel = document.getElementById('household-label');
    const typeSelect = document.getElementById('type');
    const categorySelect = document.getElementById('category');
    const dateEl = document.getElementById('date'); if (dateEl) dateEl.valueAsDate = new Date();

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    function activateTab(tabId) {
      tabContents.forEach(c => c.classList.remove('active'));
      const targetTab = document.getElementById(`${tabId}-tab`);
      if (targetTab) targetTab.classList.add('active');
      tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-tab') === tabId));
    }
    tabs.forEach(tab => tab.addEventListener('click', () => activateTab(tab.getAttribute('data-tab'))));

    function openModal(el){ if (el) el.style.display='flex'; }
    function closeModal(el){ if (el) el.style.display='none'; }
    document.querySelectorAll('.close-modal').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-close');
        if (target) closeModal(document.querySelector(target));
        else closeModal(btn.closest('.modal'));
      });
    });
    window.addEventListener('click', (e) => {
      document.querySelectorAll('.modal').forEach(m => { if (e.target === m) m.style.display = 'none'; });
    });

    function showNotification(message){
      const n = document.getElementById('notification');
      if (!n) return;
      n.textContent = message;
      n.classList.add('show');
      setTimeout(()=> n.classList.remove('show'), 2600);
    }

    // ====== STATE ======
    let categories = [];
    let transactions = [];
    let handles = null;
    let unsubCats = null;
    let unsubTx = null;

    const {
      addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy,
      getDocs, where, writeBatch, getHouseholdHandles
    } = window.$rt || {};

    // ====== HOUSEHOLD BINDING ======
    async function bindHousehold(householdId){
      if (typeof unsubCats === 'function') { unsubCats(); unsubCats = null; }
      if (typeof unsubTx === 'function') { unsubTx(); unsubTx = null; }

      categories = [];
      transactions = [];
      renderTransactions();
      renderCategoryBadges();
      updateSummary(); renderSummaryChart(); renderSummaryTable();

      handles = await getHouseholdHandles(householdId);
      if (hhLabel) hhLabel.textContent = handles.householdId;

      unsubCats = onSnapshot(handles.categoriesCol, (snap) => {
        categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rebuildCategoryOptions();
        renderCategoryBadges();
        renderSummaryChart();
        renderSummaryTable();
      });

      unsubTx = onSnapshot(query(handles.transactionsCol, orderBy('date','desc')), (snap) => {
        transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTransactions();
        updateSummary();
        renderCategoryBadges();
        renderSummaryChart();
        renderSummaryTable();
      });
    }

    // Start when auth is ready
    if (window.firebaseAuth && typeof window.firebaseAuth.onAuthStateChanged === 'function') {
      window.firebaseAuth.onAuthStateChanged(async ()=>{
        if (invitedHousehold) {
          await bindHousehold(invitedHousehold);
        } else {
          // No invite in URL: show link creator
          showInviteCreator();
        }
      });
    }

    // ====== UI BUILDERS ======
    function rebuildCategoryOptions() {
      while (categorySelect.options.length > 1) categorySelect.remove(1);
      const currentType = typeSelect.value;
      categories.forEach(c => {
        if (c.type === currentType) {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          categorySelect.appendChild(opt);
        }
      });
    }
    typeSelect.addEventListener('change', rebuildCategoryOptions);

    function renderCategoryBadges() {
      const wrap = document.getElementById('category-badges');
      if (!wrap) return;
      wrap.innerHTML = '';
      if (categories.length === 0) {
        wrap.innerHTML = '<p>No categories yet. Add one to get started.</p>';
        return;
      }
      categories.forEach((category) => {
        const sumForCat = transactions
          .filter(t => t.category === category.name && t.type === category.type)
          .reduce((s, t) => s + Number(t.amount || 0), 0);

        const hasBudget = typeof category.budget === 'number' && category.budget > 0;
        const percent = hasBudget ? Math.min(100, (sumForCat / category.budget) * 100) : 0;

        let progressClass = 'progress-safe';
        if (hasBudget) {
          if (percent > 75) progressClass = 'progress-danger';
          else if (percent > 50) progressClass = 'progress-warning';
        }

        const headerRight = hasBudget
          ? (category.type === 'expense'
              ? `$${sumForCat.toFixed(2)} / $${category.budget.toFixed(2)}`
              : `$${sumForCat.toFixed(2)} / target $${category.budget.toFixed(2)}`)
          : `$${sumForCat.toFixed(2)}`;

        const remainingText = hasBudget
          ? (category.type === 'expense'
              ? `$${(category.budget - sumForCat).toFixed(2)} left`
              : `$${(category.budget - sumForCat).toFixed(2)} to target`)
          : 'No limit set';

        const badge = document.createElement('div');
        badge.className = 'category-badge';
        badge.innerHTML = `
          <div class="category-header">
            <span class="category-name">${category.name} <small style="color:#6c757d;">(${category.type})</small></span>
            <span class="category-amount">${headerRight}</span>
          </div>
          <div class="progress-bar" ${hasBudget ? '' : 'style="opacity:.45;"'}>
            <div class="progress ${progressClass}" style="width:${hasBudget ? percent : 0}%"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:.85rem;color:#6c757d;">
            <span>${hasBudget ? `${percent.toFixed(0)}%` : '—'}</span>
            <span>${remainingText}</span>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn-secondary btn-view" data-id="${category.id}" style="flex:1;">View items</button>
            <button class="btn-success btn-edit" data-id="${category.id}" style="flex:1;">Edit</button>
          </div>
        `;
        wrap.appendChild(badge);
      });

      wrap.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-id')));
      });
      wrap.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', () => openDetailModal(btn.getAttribute('data-id')));
      });
    }

    function renderTransactions() {
      const list = document.getElementById('transaction-list');
      if (!list) return;
      if (transactions.length === 0) {
        list.innerHTML = `<div class="transaction-item"><div>No transactions yet</div><div>$0.00</div></div>`;
        return;
      }
      const recent = transactions.slice(0,12);
      list.innerHTML = recent.map(t => `
        <div class="transaction-item">
          <div class="transaction-title">
            <i class="fas ${t.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}" style="margin-right:8px;"></i>
            ${t.description || 'No description'}
            <small style="color:#6c757d;margin-left:8px;">(${t.date})</small>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="${t.type==='income'?'income':'expense'}">
              ${t.type==='income'?'+':'-'}$${Number(t.amount||0).toFixed(2)}
            </div>
            <button class="btn-secondary tx-edit" data-id="${t.id}" style="width:auto;padding:6px 10px;">Edit</button>
          </div>
        </div>`).join('');
      list.querySelectorAll('.tx-edit').forEach(btn=>{
        btn.addEventListener('click', ()=> openTxModal(btn.getAttribute('data-id')));
      });
    }

    function updateSummary() {
      const totalIncome = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
      const totalExpenses = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
      const remaining = totalIncome - totalExpenses;
      document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
      document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
      const remainingEl = document.getElementById('remaining-budget');
      remainingEl.textContent = `$${remaining.toFixed(2)}`;
      remainingEl.style.color = remaining < 0 ? '#ffe3e3' : '#eaffea';
    }

    // ====== SUMMARY CHART & TABLE ======
    function computeCategoryStats(){
      return categories.map(c => {
        const spent = transactions
          .filter(t => t.category === c.name && t.type === c.type)
          .reduce((s,t)=> s + Number(t.amount||0), 0);
        const budget = Number(c.budget || 0);
        const available = budget > 0 ? (budget - spent) : 0;
        return { name: c.name, type: c.type, budget, spent, available };
      });
    }
    function renderSummaryTable(){
      const wrap = document.getElementById('summary-table');
      if (!wrap) return;
      const rows = computeCategoryStats().map(s => `
        <tr>
          <td>${s.name}</td>
          <td>${s.type}</td>
          <td style="text-align:right">${s.budget > 0 ? '$'+s.budget.toFixed(2) : '—'}</td>
          <td style="text-align:right">$${s.spent.toFixed(2)}</td>
          <td style="text-align:right">${s.budget > 0 ? '$'+Math.max(0, s.available).toFixed(2) : '—'}</td>
        </tr>
      `).join('');
      wrap.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:.95rem;">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #eee;">Category</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #eee;">Type</th>
              <th style="text-align:right;padding:6px;border-bottom:1px solid #eee;">Budget/Target</th>
              <th style="text-align:right;padding:6px;border-bottom:1px solid #eee;">Spent/Received</th>
              <th style="text-align:right;padding:6px;border-bottom:1px solid #eee;">Available</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" style="padding:8px;color:#6c757d;">No categories yet.</td></tr>`}
          </tbody>
        </table>
      `;
    }
    function renderSummaryChart(){
      const canvas = document.getElementById('summary-chart');
      if (!canvas || typeof Chart === 'undefined') return;
      const stats = computeCategoryStats().filter(s => s.type === 'expense' && s.budget > 0);
      const labels = stats.map(s => s.name);
      const spent  = stats.map(s => Math.min(s.spent, s.budget));
      const avail  = stats.map(s => Math.max(0, s.budget - s.spent));
      if (window.summaryChart) { window.summaryChart.destroy(); window.summaryChart = null; }
      const ctx = canvas.getContext('2d');
      window.summaryChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{label:'Spent',data:spent,stack:'b'},{label:'Available',data:avail,stack:'b'}] },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{beginAtZero:true,title:{display:true,text:'Amount ($)'}} },
          plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{footer(c){const i=c[0].dataIndex;const s=stats[i];return `Budget: $${s.budget.toFixed(2)} | Spent: $${s.spent.toFixed(2)} | Available: $${Math.max(0,s.available).toFixed(2)}`;}}}}
        }
      });
    }

    // ====== CATEGORY ADD ======
    const categoryModal = document.getElementById('category-modal');
    document.getElementById('add-category-btn').addEventListener('click', ()=> openModal(categoryModal));
    document.getElementById('category-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const name   = document.getElementById('category-name').value.trim();
      const type   = document.getElementById('category-type').value;
      const budget = parseFloat(document.getElementById('category-budget').value) || 0;
      if (!name) return;
      const exists = categories.some(c => c.name.toLowerCase() === name.toLowerCase() && c.type === type);
      if (exists) { showNotification('Category already exists for this type.'); return; }
      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await addDoc(handles.categoriesCol, { name, type, budget });
        this.reset(); closeModal(categoryModal); showNotification('Category added!');
      } catch (err) { console.error(err); showNotification(`Error: ${err.message || err}`); }
      finally { btn.disabled = false; }
    });

    // ====== CATEGORY EDIT (cascade) ======
    const editModal = document.getElementById('category-edit-modal');
    document.getElementById('category-edit-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const id = document.getElementById('edit-category-id').value;
      const oldName = document.getElementById('edit-old-name').value;
      const oldType = document.getElementById('edit-old-type').value;
      const newName = document.getElementById('edit-category-name').value.trim();
      const newType = document.getElementById('edit-category-type').value;
      const newBudget = parseFloat(document.getElementById('edit-category-budget').value) || 0;
      const dup = categories.some(c => c.id !== id && c.name.toLowerCase() === newName.toLowerCase() && c.type === newType);
      if (dup) { showNotification('Another category with this name & type exists.'); return; }
      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await window.$rt.updateDoc(window.$rt.doc(handles.categoriesCol, id), { name: newName, type: newType, budget: newBudget });
        const changed = (oldName !== newName) || (oldType !== newType);
        if (changed) {
          const q = window.$rt.query(handles.transactionsCol,
            window.$rt.where('category','==',oldName),
            window.$rt.where('type','==',oldType));
          const snap = await window.$rt.getDocs(q);
          if (!snap.empty) {
            const batch = window.$rt.writeBatch(window.$rt.db);
            snap.forEach(d => batch.update(d.ref, { category: newName, type: newType }));
            await batch.commit();
          }
        }
        closeModal(editModal); showNotification('Category updated!');
      } catch (err) { console.error(err); showNotification(`Error: ${err.message || err}`); }
      finally { btn.disabled = false; }
    });
    function openEditModal(id){
      const cat = categories.find(c => c.id === id);
      if (!cat) return;
      document.getElementById('edit-category-id').value = id;
      document.getElementById('edit-old-name').value = cat.name;
      document.getElementById('edit-old-type').value = cat.type;
      document.getElementById('edit-category-name').value = cat.name;
      document.getElementById('edit-category-type').value = cat.type;
      document.getElementById('edit-category-budget').value = cat.budget || 0;
      openModal(editModal);
    }

    // ====== CATEGORY DETAIL ======
    const detailModal = document.getElementById('category-detail-modal');
    const detailTitle = document.getElementById('detail-title');
    const detailItems = document.getElementById('detail-items');
    const detailSummary = document.getElementById('detail-summary');
    function openDetailModal(id){
      const cat = categories.find(c => c.id === id);
      if (!cat) return;
      const items = transactions.filter(t => t.category === cat.name && t.type === cat.type);
      const total = items.reduce((s,t)=> s + Number(t.amount||0), 0);
      const budget = cat.budget || 0;
      detailTitle.textContent = `${cat.name} (${cat.type})`;
      detailSummary.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div><strong>Total ${cat.type === 'expense' ? 'spent' : 'received'}:</strong> $${total.toFixed(2)}</div>
          <div><strong>${cat.type === 'expense' ? 'Budget' : 'Target'}:</strong> ${budget > 0 ? '$'+budget.toFixed(2) : '—'}</div>
          ${budget > 0 ? `<div><strong>${cat.type === 'expense' ? 'Left' : 'To target'}:</strong> $${(budget - total).toFixed(2)}</div>` : ''}
        </div>`;
      if (items.length === 0) {
        detailItems.innerHTML = `<p style="margin-top:10px;">No ${cat.type} entries in this category yet.</p>`;
      } else {
        detailItems.innerHTML = items
          .sort((a,b)=> new Date(b.date) - new Date(a.date))
          .map(item => `
            <div class="transaction-item" style="padding-left:0;">
              <div class="transaction-title">
                <i class="fas ${item.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}"></i>
                ${item.description || 'No description'} <small style="color:#6c757d;margin-left:8px;">(${item.date})</small>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <div class="${item.type==='income'?'income':'expense'}">
                  ${item.type==='income'?'+':'-'}$${Number(item.amount||0).toFixed(2)}
                </div>
                <button class="btn-secondary tx-edit" data-id="${item.id}" style="width:auto;padding:6px 10px;">Edit</button>
              </div>
            </div>`).join('');
        detailItems.querySelectorAll('.tx-edit').forEach(btn=>{
          btn.addEventListener('click', ()=> openTxModal(btn.getAttribute('data-id')));
        });
      }
      openModal(detailModal);
    }

    // ====== TRANSACTION EDIT ======
    function fillTxCategoryOptions(typeValue, selectEl, preselectValue){
      while (selectEl.options.length > 1) selectEl.remove(1);
      categories.forEach(c => {
        if (c.type === typeValue) {
          const opt = document.createElement('option');
          opt.value = c.name; opt.textContent = c.name;
          selectEl.appendChild(opt);
        }
      });
      if (preselectValue) selectEl.value = preselectValue;
    }
    function openTxModal(id){
      const tx = transactions.find(t => t.id === id);
      if (!tx) return;
      document.getElementById('tx-id').value = id;
      const typeSel = document.getElementById('tx-type');
      const catSel  = document.getElementById('tx-category');
      typeSel.value = tx.type;
      fillTxCategoryOptions(tx.type, catSel, tx.category);
      document.getElementById('tx-amount').value = Number(tx.amount||0).toFixed(2);
      document.getElementById('tx-date').value = tx.date;
      document.getElementById('tx-desc').value = tx.description || '';
      openModal(document.getElementById('tx-modal'));
    }
    document.getElementById('tx-type').addEventListener('change', (e)=>{
      fillTxCategoryOptions(e.target.value, document.getElementById('tx-category'));
    });
    document.getElementById('tx-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id   = document.getElementById('tx-id').value;
      const type = document.getElementById('tx-type').value;
      const cat  = document.getElementById('tx-category').value;
      const amt  = parseFloat(document.getElementById('tx-amount').value);
      const date = document.getElementById('tx-date').value;
      const desc = (document.getElementById('tx-desc').value || '').trim();
      if (!cat || !isFinite(amt)) { showNotification('Please enter valid values.'); return; }
      try{
        await window.$rt.updateDoc(window.$rt.doc(handles.transactionsCol, id),
          { type, category: cat, amount: Number(amt.toFixed(2)), date, description: desc });
        closeModal(document.getElementById('tx-modal'));
        showNotification('Transaction updated.');
      }catch(err){ console.error(err); showNotification(`Update failed: ${err.message || err}`); }
    });
    document.getElementById('tx-delete').addEventListener('click', async ()=>{
      const id = document.getElementById('tx-id').value;
      if (!id) return;
      if (!confirm('Delete this transaction?')) return;
      try{
        await window.$rt.deleteDoc(window.$rt.doc(handles.transactionsCol, id));
        closeModal(document.getElementById('tx-modal'));
        showNotification('Transaction deleted.');
      }catch(err){ console.error(err); showNotification(`Delete failed: ${err.message || err}`); }
    });

    // ====== TRANSACTION ADD ======
    document.getElementById('transaction-form').addEventListener('submit', async function(e){
      e.preventDefault();
      if (!handles) { showNotification('No household bound. Use an invite link.'); return; }
      const selectedCategory = categorySelect.value;
      if (!selectedCategory) { showNotification('Please choose a category first.'); return; }
      const amountVal = parseFloat(document.getElementById('amount').value);
      if (!isFinite(amountVal) || amountVal < 0) { showNotification('Enter a valid amount (>= 0).'); return; }
      const transaction = {
        type: typeSelect.value,
        category: selectedCategory,
        amount: Number(amountVal.toFixed(2)),
        date: document.getElementById('date').value,
        description: (document.getElementById('description').value || 'No description').trim(),
        createdAt: Date.now()
      };
      const btn = this.querySelector('button[type="submit"]'); btn.disabled = true;
      try {
        await addDoc(handles.transactionsCol, transaction);
        this.reset(); if (dateEl) dateEl.valueAsDate = new Date(); typeSelect.value = 'income'; rebuildCategoryOptions();
        showNotification('Transaction added!');
      } catch (err) { console.error(err); showNotification(`Error adding: ${err.message || err}`); }
      finally { btn.disabled = false; }
    });

    // ====== CLEAR ALL ======
    document.getElementById('clear-btn').addEventListener('click', async function(){
      if (!handles) return;
      if (!confirm('Are you sure? This erases EVERYTHING for this household.')) return;
      try{
        const delCat = async () => { for (const c of categories) await deleteDoc(doc(handles.categoriesCol, c.id)); };
        const delTx = async () => { for (const t of transactions) await deleteDoc(doc(handles.transactionsCol, t.id)); };
        await delTx(); await delCat(); showNotification('All data cleared for this household.');
      }catch(err){ console.error(err); showNotification(`Error clearing: ${err.message || err}`); }
    });

    // ====== HOUSEHOLD SWITCH ======
    const householdModal = document.getElementById('household-modal');
    document.getElementById('switch-household-btn').addEventListener('click', ()=> {
      const input = document.getElementById('household-input');
      if (input) input.value = handles?.householdId || '';
      openModal(householdModal);
    });
    document.getElementById('household-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const newId = (document.getElementById('household-input').value || '').trim();
      if (!newId) return;
      history.replaceState({}, document.title, `${BASE_URL}?h=${encodeURIComponent(newId)}`);
      invitedHousehold = newId;
      await bindHousehold(newId);
      closeModal(householdModal);
      showNotification(`Switched to: ${newId}`);
    });

  });
  </script>

  <div class="notification" id="notification">Done!</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Budget Tracker (Realtime)</title>
<link rel="icon" href="data:,">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f172a; --bg2:#0b1224; --bg3:#131a2f;
    --card:#111827; --card2:#0b1120;
    --border:#1f2937; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#6ea8fe; --brand2:#4c72ff;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --topbar-h:56px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%; width:100%; max-width:100%}
  html{ -webkit-text-size-adjust: 100%; }
  body{
    font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 20% -10%, var(--bg3), transparent),
      radial-gradient(900px 600px at 100% 0%, #1c254a66, transparent),
      linear-gradient(180deg, var(--bg2), var(--bg));
    min-height:100dvh;
    padding-top: calc(env(safe-area-inset-top) + 8px);
    padding-bottom: calc(24px + env(safe-area-inset-bottom));
    padding-left: 12px; padding-right: 12px;
    display:flex;flex-direction:column;align-items:center;
    font-size: 18px; line-height: 1.6;
  }
  .container{width:100%;max-width:980px}
  header{text-align:center;margin:6px 0 8px;}
  header h1{font-size:2rem}
  header p{color:var(--muted);margin-top:6px; font-size:1.1rem}

  /* Top tabs (single nav) */
  .tabs{
    position:sticky; top:calc(env(safe-area-inset-top) + 0px); z-index:20;
    display:flex; gap:6px; height:var(--topbar-h); align-items:center;
    background:transparent; padding:6px 0 8px; backdrop-filter:blur(6px)
  }
  .tab{
    flex:1;text-align:center;cursor:pointer;font-weight:800;
    padding:12px 10px;border-radius:12px;color:var(--muted);
    background:rgba(255,255,255,0.03);border:1px solid var(--border);
    transition:transform .08s ease,filter .2s ease,background .2s ease
  }
  .tab:active{transform:translateY(2px) scale(.99)}
  .tab.active{
    color:#0b1224;background:linear-gradient(160deg,#9bbcff,#5c7cff);
    border-color:transparent;box-shadow:0 10px 28px rgba(78,114,255,.22), inset 0 0 0 1px #cbd5ff40
  }

  .app-container{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:820px){.app-container{grid-template-columns:1fr 1fr}}

  .card{
    background:linear-gradient(180deg,var(--card),var(--card2));
    border:1px solid var(--border);border-radius:16px;padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)
  }
  .card-title{display:flex;align-items:center;justify-content:space-between;color:#dbeafe;font-size:1.3rem;margin-bottom:12px}

  /* Sections must leave space for sticky tabs on scrollIntoView */
  .tab-content{scroll-margin-top: calc(var(--topbar-h) + env(safe-area-inset-top) + 8px);}

  label{display:block;margin:8px 0 6px;color:#cbd5e1;font-weight:800}
  input,select{
    width:100%;background:#0b1120;color:var(--text);
    border:1px solid var(--border);border-radius:14px;padding:14px;font-size:18px;min-height:52px;outline:none;
    transition: box-shadow .2s, transform .06s;
  }
  input:focus,select:focus{border-color:#395cff;box-shadow:0 6px 24px rgba(78,114,255,.18), 0 0 0 3px #2b4fff40}
  button{
    min-height:52px;border:none;border-radius:16px;cursor:pointer;font-weight:900;letter-spacing:.2px;
    color:#0b1224;background:linear-gradient(160deg,#9bbcff,#5c7cff);
    box-shadow:0 10px 24px rgba(45,78,255,.25), inset 0 0 0 1px #cbd5ff40;transition:transform .08s ease,filter .2s
    ;font-size:18px;padding:14px 18px;
  }
  button:hover{filter:brightness(1.02)}
  button:active{transform:translateY(2px) scale(.99)}
  .btn-secondary{background:linear-gradient(160deg,#cbd5e11a,#94a3b81a);color:#e5e7eb;box-shadow:inset 0 0 0 1px #74809b40}
  .btn-danger{background:linear-gradient(160deg,#ff7474,#ff4b4b);color:#fff;box-shadow:0 10px 24px rgba(255,80,80,.25)}
  .btn-success{background:linear-gradient(160deg,#5df3a6,#2fd071);color:#0b1224;box-shadow:0 10px 24px rgba(72,255,164,.25)}

  .transaction-list{max-height:360px;overflow-y:auto;-webkit-overflow-scrolling:touch}
  .transaction-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:1px solid var(--border);font-size:1rem}
  .transaction-item:first-child{border-top:none}
  .income{color:var(--ok)} .expense{color:var(--bad)}

  .category-badges{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:560px){.category-badges{grid-template-columns:1fr 1fr}}
  .category-badge{background:#0b1120;border:1px solid var(--border);border-radius:14px;padding:12px;font-size:1rem}
  .category-header{display:flex;justify-content:space-between;margin-bottom:8px;color:#e2e8f0}
  .progress-bar{height:10px;background:#1f2937;border-radius:6px;overflow:hidden}
  .progress{height:100%}
  .progress-safe{background:var(--ok)} .progress-warning{background:var(--warn)} .progress-danger{background:var(--bad)}

  .summary-card{background:linear-gradient(180deg,#0c1326,#0b1120);border:1px solid #243056}
  .summary-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #243056;font-size:1rem}
  .summary-item:last-child{border-bottom:none}

  .amount-chips { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
  .amount-chip {
    background:#0b1120; border:1px solid var(--border); border-radius:999px;
    padding:10px 16px; font-weight:800; color:#e5e7eb; cursor:pointer;
    transition: transform .05s; font-size:18px;
  }
  .amount-chip:active { transform: translateY(1px); }

  .modal{display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center;padding:12px;background:rgba(4,7,16,.65);backdrop-filter:blur(6px)}
  .modal-content{background:linear-gradient(180deg,#0b1120,#0a0f1c);color:var(--text);border:1px solid var(--border);border-radius:16px;padding:16px;width:100%;max-width:500px;max-height:90vh;overflow:auto}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .close-modal{background:none;border:none;color:#94a3b8;font-size:1.8rem}

  .notification{position:fixed;top:18px;right:18px;background:#0b1120;border:1px solid #26304b;color:#fff;padding:12px 16px;border-radius:12px;transform:translateX(140%);transition:transform .3s;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:1100}
  .notification.show{transform:translateX(0)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ’° Budget Tracker</h1>
      <p>Realtime shared space â€¢ Mobile-first</p>
    </header>

    <!-- Top tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="transactions">Transactions</div>
      <div class="tab" data-tab="summary">Summary</div>
      <div class="tab" data-tab="categories">Categories</div>
      <div class="tab" data-tab="manage">Manage</div>
    </div>

    <!-- Main -->
    <div class="app-container">
      <!-- Transactions -->
      <section class="card tab-content" id="transactions-tab">
        <h2 class="card-title"><span><i class="fas fa-plus-circle"></i> Add Transaction</span></h2>
        <form id="transaction-form">
          <label>Type</label>
          <select id="type" required><option value="income">Income</option><option value="expense">Expense</option></select>

          <label>Category</label>
          <select id="category" required><option value="">Select a category</option></select>

          <label>Amount ($)</label>
          <input type="number" id="amount" min="0" step="0.01" required>
          <div class="amount-chips" id="amount-chips">
            <button type="button" class="amount-chip" data-a="5">+ $5</button>
            <button type="button" class="amount-chip" data-a="10">+ $10</button>
            <button type="button" class="amount-chip" data-a="20">+ $20</button>
            <button type="button" class="amount-chip" data-a="50">+ $50</button>
          </div>

          <label>Date</label><input type="date" id="date" required>
          <label>Description</label><input type="text" id="description" placeholder="Optional">

          <div style="display:flex;gap:10px;margin-top:10px;">
            <button type="submit" class="btn-success" style="flex:1"><i class="fa-solid fa-plus"></i> Add</button>
          </div>
        </form>
      </section>

      <!-- Summary -->
      <section class="card summary-card tab-content" id="summary-tab">
        <h2 class="card-title"><i class="fas fa-chart-pie"></i> Budget Summary</h2>
        <div class="summary-item"><span>Total Income:</span><span id="total-income">$0.00</span></div>
        <div class="summary-item"><span>Total Expenses:</span><span id="total-expenses">$0.00</span></div>
        <div class="summary-item"><span>Remaining Budget:</span><span id="remaining-budget">$0.00</span></div>
        <div style="background:#0b1120;border:1px solid #243056;border-radius:12px;margin-top:12px;padding:12px;height:360px;">
          <canvas id="summary-chart"></canvas>
          <div id="summary-table" style="overflow-x:auto;margin-top:12px;"></div>
        </div>
      </section>

      <!-- Categories -->
      <section class="card tab-content" id="categories-tab">
        <h2 class="card-title">
          <span><i class="fas fa-tags"></i> Categories</span>
          <button id="add-category-btn" style="width:auto"><i class="fas fa-plus"></i> Add New</button>
        </h2>
        <div class="category-badges" id="category-badges"></div>
      </section>

      <!-- Manage -->
      <section class="card tab-content" id="manage-tab">
        <h2 class="card-title"><i class="fas fa-cog"></i> Manage</h2>
        <div style="display:grid;gap:10px;">
          <div>
            <div style="color:#cbd5e1;margin-bottom:6px;">Shared space ID:</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <b id="household-label" style="font-family:ui-monospace,Menlo,Consolas,monospace;"></b>
              <button id="copy-household" class="btn-secondary" style="width:auto;padding:8px 10px;">Copy ID</button>
            </div>
          </div>
          <div style="border-top:1px dashed var(--border); padding-top:10px;">
            <div style="color:#cbd5e1;margin-bottom:6px;">Invite link</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
              <button id="ensure-invite" class="btn-success" style="width:auto;padding:8px 10px;"><i class="fa-solid fa-link"></i> Show/Make invite link</button>
              <input id="invite-url-manage" readonly style="flex:1;min-width:220px;display:none"/>
              <button id="copy-link-manage" class="btn-secondary" style="width:auto;padding:8px 10px;display:none"><i class="fa-solid fa-copy"></i> Copy link</button>
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap; margin-top:6px;">
            <button id="clear-btn" class="btn-danger"><i class="fas fa-trash"></i> Clear All (danger)</button>
          </div>
        </div>
      </section>

      <!-- Recent Transactions -->
      <section class="card tab-content" id="recent-tab">
        <h2 class="card-title"><i class="fas fa-list"></i> Recent Transactions</h2>
        <div class="transaction-list" id="transaction-list">
          <div class="transaction-item"><div>No transactions yet</div><div>$0.00</div></div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Add New Category</h2><button class="close-modal" data-close="#category-modal">&times;</button></div>
      <form id="category-form">
        <label>Name</label><input type="text" id="category-name" required>
        <label>Type</label><select id="category-type" required><option value="expense">Expense</option><option value="income">Income</option></select>
        <label>Monthly Budget (expense) / Target (income)</label><input type="number" id="category-budget" min="0" step="0.01">
        <button type="submit" class="btn-success">Save Category</button>
      </form>
    </div>
  </div>

  <div class="modal" id="category-edit-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Category</h2><button class="close-modal" data-close="#category-edit-modal">&times;</button></div>
      <form id="category-edit-form">
        <input type="hidden" id="edit-category-id">
        <input type="hidden" id="edit-old-name">
        <input type="hidden" id="edit-old-type">
        <label>Name</label><input type="text" id="edit-category-name" required>
        <label>Type</label><select id="edit-category-type" required><option value="expense">Expense</option><option value="income">Income</option></select>
        <label>Monthly Amount / Budget</label><input type="number" id="edit-category-budget" min="0" step="0.01">
        <button type="submit" class="btn-success">Save</button>
        <button type="button" id="category-delete" class="btn-danger" style="margin-top:8px;">Delete Category</button>
      </form>
    </div>
  </div>

  <div class="modal" id="category-detail-modal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="detail-title">Category Details</h2><button class="close-modal" data-close="#category-detail-modal">&times;</button></div>
      <div id="detail-summary" style="margin-bottom:10px;"></div>
      <div id="detail-items"></div>
    </div>
  </div>

  <div class="modal" id="tx-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Edit Transaction</h2><button class="close-modal" data-close="#tx-modal">&times;</button></div>
      <form id="tx-form">
        <input type="hidden" id="tx-id">
        <label>Type</label><select id="tx-type" required><option value="income">Income</option><option value="expense">Expense</option></select>
        <label>Category</label><select id="tx-category" required><option value="">Select a category</option></select>
        <label>Amount ($)</label><input type="number" id="tx-amount" min="0" step="0.01" required>
        <label>Date</label><input type="date" id="tx-date" required>
        <label>Description</label><input type="text" id="tx-desc" placeholder="Description">
        <button type="submit" class="btn-success">Save</button>
        <button type="button" id="tx-delete" class="btn-danger" style="margin-top:8px;">Delete</button>
      </form>
    </div>
  </div>

  <div class="notification" id="notification">Done!</div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    // --- FORCE household id in URL on first load (before Firebase) ---
    const BASE_URL = (location.origin + location.pathname).replace(/index\.html?$/,'');
    (function ensureHHInUrl(){
      const qs = new URLSearchParams(location.search);
      if (!qs.get('h')) {
        const existing = localStorage.getItem('hh_id');
        const newId = existing || ('hh_' + Math.random().toString(36).slice(2,10) + Math.random().toString(36).slice(2,10));
        localStorage.setItem('hh_id', newId);
        history.replaceState({}, document.title, `${BASE_URL}?h=${encodeURIComponent(newId)}`);
      }
    })();

    // ===== YOUR FIREBASE CONFIG =====
    const firebaseConfig = {
      apiKey: "AIzaSyBrBqhylpvDh8j9c0eddrBuGVt3YEcU1Cs",
      authDomain: "budget-beabb.firebaseapp.com",
      projectId: "budget-beabb",
      appId: "1:222008362126:web:70db15c87c13657d16b5df"
    };

    // ===== Init Firebase (compat) =====
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const notify = (msg)=>{ const n=$("#notification"); n.textContent=msg; n.classList.add("show"); setTimeout(()=>n.classList.remove("show"),2400); };
    const haptic = (ms=8)=>{ if (navigator.vibrate) try{ navigator.vibrate(ms); }catch{} };

    // Top tabs scroll behavior (iPhone friendly)
    function scrollToSection(tabId){
      const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h')) || 56;
      const el = document.getElementById(tabId + "-tab");
      if (!el) return;
      const y = el.getBoundingClientRect().top + window.scrollY - headerH - 8;
      window.scrollTo({ top: y, behavior: "smooth" });
    }
    const sections = Array.from(document.querySelectorAll(".tab-content"));
    const tabsTop  = Array.from(document.querySelectorAll(".tab"));
    let ticking = false;
    function onScroll(){
      if (ticking) return; ticking = true;
      requestAnimationFrame(()=>{
        const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h')) || 56;
        const mid = window.scrollY + headerH + 20;
        let active = sections[0];
        for (const s of sections){ if (s.offsetTop - 2 <= mid) active = s; else break; }
        const id = active.id.replace("-tab","");
        tabsTop.forEach(t=>t.classList.toggle("active", t.dataset.tab===id));
        ticking = false;
      });
    }
    window.addEventListener("scroll", onScroll, {passive:true});
    tabsTop.forEach(tab=>tab.addEventListener("click", ()=>{ haptic(); scrollToSection(tab.dataset.tab); }));

    // App state
    const dateEl = $("#date"); if (dateEl) dateEl.valueAsDate = new Date();
    let handles=null, categories=[], transactions=[], unsubCats=null, unsubTx=null;
    let householdId = new URLSearchParams(location.search).get('h') || '';

    // Firestore helpers
    async function ensureHousehold(id){
      const ref = db.doc(`households/${id}`);
      const snap = await ref.get();
      if (!snap.exists) await ref.set({createdAt: Date.now()});
      return { id, ref, categoriesCol: ref.collection("categories"), transactionsCol: ref.collection("transactions") };
    }
    async function bindHousehold(id){
      if (unsubCats) { unsubCats(); unsubCats = null; }
      if (unsubTx)   { unsubTx();   unsubTx   = null; }
      categories=[]; transactions=[];
      renderCategories(); renderTransactions(); renderSummary(); renderSummaryChart(); renderSummaryTable();

      handles = await ensureHousehold(id);
      $("#household-label").textContent = id;

      // Invite link UI
      const link = `${BASE_URL}?h=${encodeURIComponent(id)}`;
      const inviteInput = $("#invite-url-manage");
      const copyBtn = $("#copy-link-manage");
      inviteInput.value = link; inviteInput.style.display = "inline-block";
      copyBtn.style.display = "inline-block";
      copyBtn.onclick = async () => { await navigator.clipboard.writeText(link); notify("Invite link copied!"); haptic(); };

      unsubCats = handles.categoriesCol.onSnapshot(snap=>{
        categories = snap.docs.map(d=>({id:d.id, ...d.data()}));
        rebuildCategoryOptions(); renderCategories(); renderSummaryChart(); renderSummaryTable();
      });
      unsubTx = handles.transactionsCol.orderBy("date","desc").onSnapshot(snap=>{
        transactions = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderTransactions(); renderCategories(); renderSummary(); renderSummaryChart(); renderSummaryTable();
      });
    }

    // Auth + initial bind
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    auth.onAuthStateChanged(async (user)=>{
      if (!user) { await auth.signInAnonymously().catch(console.error); return; }
      bindHousehold(householdId);
    });

    // UI builders
    function rebuildCategoryOptions(){
      const sel = $("#category");
      while (sel.options.length>1) sel.remove(1);
      const type = $("#type").value;
      categories.forEach(c=>{
        if (c.type===type){
          const o=document.createElement("option"); o.value=c.name; o.textContent=c.name; sel.appendChild(o);
        }
      });
    }
    $("#type").addEventListener("change", rebuildCategoryOptions);

    function renderCategories(){
      const wrap = $("#category-badges");
      wrap.innerHTML = "";
      if (categories.length===0){ wrap.innerHTML = '<p style="color:var(--muted)">No categories yet. Add one to get started.</p>'; return; }
      categories.forEach(c=>{
        const sum = transactions.filter(t=>t.category===c.name && t.type===c.type).reduce((s,t)=>s+Number(t.amount||0),0);
        const hasBudget = typeof c.budget==="number" && c.budget>0;
        const percent = hasBudget?Math.min(100,(sum/c.budget)*100):0;
        let pClass = 'progress-safe'; if(hasBudget){ if(percent>75)pClass='progress-danger'; else if(percent>50)pClass='progress-warning'; }
        const headerRight = hasBudget
          ? (c.type==='expense' ? `$${sum.toFixed(2)} / $${(c.budget||0).toFixed(2)}` : `$${sum.toFixed(2)} / target $${(c.budget||0).toFixed(2)}`)
          : `$${sum.toFixed(2)}`;
        const remainingText = hasBudget
          ? (c.type==='expense' ? `$${(c.budget - sum).toFixed(2)} left` : `$${(c.budget - sum).toFixed(2)} to target`)
          : 'No limit set';

        const div = document.createElement("div");
        div.className = "category-badge";
        div.innerHTML = `
          <div class="category-header">
            <span>${c.name} <small style="color:#8ea1c7;">(${c.type})</small></span>
            <span>${headerRight}</span>
          </div>
          <div class="progress-bar" ${hasBudget?'':'style="opacity:.45"'}><div class="progress ${pClass}" style="width:${hasBudget?percent:0}%"></div></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:.95rem;color:#94a3b8;">
            <span>${hasBudget?percent.toFixed(0)+'%':'â€”'}</span><span>${remainingText}</span>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn-secondary btn-view" data-id="${c.id}" style="flex:1;">View items</button>
            <button class="btn-secondary btn-edit" data-id="${c.id}" style="flex:1;">Edit</button>
          </div>
        `;
        wrap.appendChild(div);
      });

      // Wire the buttons
      wrap.querySelectorAll(".btn-view").forEach(btn=> btn.addEventListener("click", ()=> openDetailModal(btn.dataset.id)));
      wrap.querySelectorAll(".btn-edit").forEach(btn=> btn.addEventListener("click", ()=> openEditModal(btn.dataset.id)));
    }

    function renderTransactions(){
      const list = $("#transaction-list");
      if (transactions.length===0){ list.innerHTML='<div class="transaction-item"><div>No transactions yet</div><div>$0.00</div></div>'; return; }
      const rows = transactions.slice(0,12).map(t=>`
        <div class="transaction-item">
          <div><i class="fas ${t.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}" style="margin-right:8px;"></i>${t.description || 'No description'} <small style="color:#8ea1c7;margin-left:8px;">(${t.date})</small></div>
          <div class="${t.type==='income'?'income':'expense'}">${t.type==='income'?'+':'-'}$${Number(t.amount||0).toFixed(2)}</div>
        </div>`).join('');
      list.innerHTML = rows;
    }

    function renderSummary(){
      const inc = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
      const exp = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
      const rem = inc-exp;
      $("#total-income").textContent = `$${inc.toFixed(2)}`;
      $("#total-expenses").textContent = `$${exp.toFixed(2)}`;
      const r = $("#remaining-budget"); r.textContent = `$${rem.toFixed(2)}`; r.style.color = rem<0?'#ffb4b4':'#b0ffcd';
    }

    function stats(){
      return categories.map(c=>{
        const spent=transactions.filter(t=>t.category===c.name && t.type===c.type).reduce((s,t)=>s+Number(t.amount||0),0);
        const budget=Number(c.budget||0); const available=budget>0?(budget-spent):0;
        return {name:c.name,type:c.type,budget,spent,available};
      });
    }

    function renderSummaryTable(){
      const wrap = $("#summary-table");
      const rows = stats().map(s=>`
        <tr>
          <td>${s.name}</td><td>${s.type}</td>
          <td style="text-align:right">${s.budget>0?'$'+s.budget.toFixed(2):'â€”'}</td>
          <td style="text-align:right">$${s.spent.toFixed(2)}</td>
          <td style="text-align:right">${s.budget>0?'$'+Math.max(0,s.available).toFixed(2):'â€”'}</td>
        </tr>`).join('');
      wrap.innerHTML = `
        <table style="width:100%;border-collapse:collapse;font-size:1rem;">
          <thead>
            <tr style="color:#cbd5e1;">
              <th style="text-align:left;padding:8px;border-bottom:1px solid #243056;">Category</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #243056;">Type</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #243056;">Budget/Target</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #243056;">Spent/Received</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #243056;">Available</th>
            </tr>
          </thead>
          <tbody style="color:#dbeafe;">${rows || `<tr><td colspan="5" style="padding:10px;color:#8ea1c7;">No categories yet.</td></tr>`}</tbody>
        </table>`;
    }

    function renderSummaryChart(){
      const canvas = document.getElementById("summary-chart");
      if (!canvas || typeof Chart==='undefined') return;
      const s = stats().filter(x=>x.type==='expense' && x.budget>0);
      const labels = s.map(x=>x.name);
      const spent  = s.map(x=>Math.min(x.spent,x.budget));
      const avail  = s.map(x=>Math.max(0,x.budget-x.spent));
      if (window.summaryChart){ window.summaryChart.destroy(); window.summaryChart = null; }
      const ctx = canvas.getContext("2d");
      window.summaryChart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[ {label:'Spent',data:spent,stack:'b'}, {label:'Available',data:avail,stack:'b'} ] },
        options:{ responsive:true, maintainAspectRatio:false,
          scales:{ y:{beginAtZero:true, grid:{color:'#243056'}, ticks:{color:'#cbd5e1'}},
                   x:{grid:{color:'#243056'}, ticks:{color:'#cbd5e1'}}},
          plugins:{ legend:{position:'bottom', labels:{color:'#cbd5e1'} } }
        }
      });
    }

    // Add Category
    $("#add-category-btn").addEventListener("click", ()=> $("#category-modal").style.display='flex');
    $("#category-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!handles) return;
      const name = $("#category-name").value.trim();
      const type = $("#category-type").value;
      const budget = parseFloat($("#category-budget").value)||0;
      if (!name) return;
      const exists = categories.some(c=>c.name.toLowerCase()===name.toLowerCase() && c.type===type);
      if (exists) { notify("Category already exists."); return; }
      try {
        await handles.categoriesCol.add({ name, type, budget });
        e.target.reset(); $("#category-modal").style.display='none'; notify("Category added!"); haptic();
      } catch (err) { console.error(err); notify("Error adding category"); }
    });

    // Category Edit (with cascade rename)
    function openEditModal(id){
      const cat = categories.find(c=>c.id===id); if (!cat) return;
      $("#edit-category-id").value = id;
      $("#edit-old-name").value = cat.name;
      $("#edit-old-type").value = cat.type;
      $("#edit-category-name").value = cat.name;
      $("#edit-category-type").value = cat.type;
      $("#edit-category-budget").value = cat.budget || 0;
      $("#category-edit-modal").style.display = 'flex';
    }
    document.getElementById('category-edit-form').addEventListener('submit', async (e)=>{
      e.preventDefault(); if (!handles) return;
      const id = $("#edit-category-id").value;
      const oldName = $("#edit-old-name").value;
      const oldType = $("#edit-old-type").value;
      const newName = $("#edit-category-name").value.trim();
      const newType = $("#edit-category-type").value;
      const newBudget = parseFloat($("#edit-category-budget").value)||0;

      const dup = categories.some(c=>c.id!==id && c.name.toLowerCase()===newName.toLowerCase() && c.type===newType);
      if (dup){ notify('Another category with this name & type exists.'); return; }

      try{
        await handles.categoriesCol.doc(id).update({ name:newName, type:newType, budget:newBudget });
        if (oldName!==newName || oldType!==newType){
          const q = handles.transactionsCol.where('category','==',oldName).where('type','==',oldType);
          const snap = await q.get();
          if (!snap.empty){
            const batch = db.batch();
            snap.docs.forEach(d=> batch.update(d.ref, { category:newName, type:newType }));
            await batch.commit();
          }
        }
        $("#category-edit-modal").style.display='none';
        notify('Category updated.');
      }catch(err){ console.error(err); notify('Error updating category.'); }
    });

    // Delete category (optional cascade)
    document.getElementById('category-delete').addEventListener('click', async ()=>{
      if (!handles) return;

      const id = document.getElementById('edit-category-id').value;
      const oldName = document.getElementById('edit-old-name').value;
      const oldType = document.getElementById('edit-old-type').value;

      if (!confirm(`Delete category "${oldName}" (${oldType})?`)) return;

      try {
        const q = handles.transactionsCol.where('category','==',oldName).where('type','==',oldType);
        const snap = await q.get();
        let alsoDeleteTx = false;

        if (!snap.empty) {
          alsoDeleteTx = confirm(`There are ${snap.size} transaction(s) in this category.\nOK = delete them too.\nCancel = keep transactions.`);
        }

        const batch = db.batch();
        batch.delete(handles.categoriesCol.doc(id));
        if (alsoDeleteTx && !snap.empty) snap.docs.forEach(d=> batch.delete(d.ref));
        await batch.commit();

        document.getElementById('category-edit-modal').style.display='none';
        notify(alsoDeleteTx ? 'Category and its transactions deleted.' : 'Category deleted.');
      } catch (err) {
        console.error(err);
        notify('Failed to delete category.');
      }
    });

    // Category Details â†’ list items with Edit buttons
    function openDetailModal(id){
      const cat = categories.find(c=>c.id===id); if (!cat) return;
      const items = transactions.filter(t=>t.category===cat.name && t.type===cat.type);
      const total = items.reduce((s,t)=>s+Number(t.amount||0),0);
      const budget = Number(cat.budget||0);

      $("#detail-title").textContent = `${cat.name} (${cat.type})`;
      $("#detail-summary").innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:#cbd5e1;">
          <div><strong>Total ${cat.type==='expense'?'spent':'received'}:</strong> $${total.toFixed(2)}</div>
          <div><strong>${cat.type==='expense'?'Budget':'Target'}:</strong> ${budget>0?'$'+budget.toFixed(2):'â€”'}</div>
          ${budget>0?`<div><strong>${cat.type==='expense'?'Left':'To target'}:</strong> $${(budget-total).toFixed(2)}</div>`:''}
        </div>`;
      $("#detail-items").innerHTML = items.length===0
        ? `<p style="margin-top:10px;color:#8ea1c7;">No ${cat.type} entries in this category yet.</p>`
        : items.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(item=>`
          <div class="transaction-item" style="padding-left:0;">
            <div class="transaction-title">
              <i class="fas ${item.type==='income'?'fa-arrow-up-right income':'fa-arrow-down-left expense'}"></i>
              ${item.description || 'No description'} <small style="color:#8ea1c7;margin-left:8px;">(${item.date})</small>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <div class="${item.type==='income'?'income':'expense'}">${item.type==='income'?'+':'-'}$${Number(item.amount||0).toFixed(2)}</div>
              <button class="btn-secondary tx-edit" data-id="${item.id}" style="width:auto;padding:6px 10px;">Edit</button>
            </div>
          </div>`).join('');
      document.querySelectorAll("#category-detail-modal .tx-edit").forEach(btn=> btn.addEventListener("click", ()=> openTxModal(btn.dataset.id)));
      $("#category-detail-modal").style.display = "flex";
    }

    // Transaction edit modal
    function openTxModal(id){
      const tx = transactions.find(t=>t.id===id); if (!tx) return;
      $("#tx-id").value = id;
      const typeSel = $("#tx-type");
      const catSel  = $("#tx-category");

      // rebuild categories list for the tx's type
      while (catSel.options.length>1) catSel.remove(1);
      categories.forEach(c=>{ if (c.type===tx.type){ const opt=document.createElement('option'); opt.value=c.name; opt.textContent=c.name; catSel.appendChild(opt); } });

      typeSel.value = tx.type;
      catSel.value  = tx.category;
      $("#tx-amount").value = Number(tx.amount||0).toFixed(2);
      $("#tx-date").value   = tx.date;
      $("#tx-desc").value   = tx.description || '';
      $("#tx-modal").style.display = 'flex';
    }
    document.getElementById('tx-type').addEventListener('change', (e)=>{
      const catSel  = document.getElementById('tx-category');
      while (catSel.options.length>1) catSel.remove(1);
      categories.forEach(c=>{ if (c.type===e.target.value){ const opt=document.createElement('option'); opt.value=c.name; opt.textContent=c.name; catSel.appendChild(opt);} });
    });
    document.getElementById('tx-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!handles) return;
      const id   = document.getElementById('tx-id').value;
      const type = document.getElementById('tx-type').value;
      const cat  = document.getElementById('tx-category').value;
      const amt  = parseFloat(document.getElementById('tx-amount').value);
      const date = document.getElementById('tx-date').value;
      const desc = (document.getElementById('tx-desc').value||'').trim();
      if (!cat || !isFinite(amt)) { notify('Please enter valid values.'); return; }
      try {
        await handles.transactionsCol.doc(id).update({ type, category:cat, amount:Number(amt.toFixed(2)), date, description:desc });
        document.getElementById('tx-modal').style.display='none';
        notify('Transaction updated.'); haptic();
      } catch(err){ console.error(err); notify('Update failed.'); }
    });
    document.getElementById('tx-delete').addEventListener('click', async ()=>{
      const id = document.getElementById('tx-id').value; if (!id) return;
      if (!confirm('Delete this transaction?')) return;
      try {
        await handles.transactionsCol.doc(id).delete();
        document.getElementById('tx-modal').style.display='none';
        notify('Transaction deleted.'); haptic();
      } catch(err){ console.error(err); notify('Delete failed.'); }
    });

    // Add Transaction
    const amountInput = document.getElementById("amount");
    document.querySelectorAll("#amount-chips .amount-chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        const add = parseFloat(ch.dataset.a);
        const cur = parseFloat(amountInput.value || "0") || 0;
        amountInput.value = (cur + add).toFixed(2);
        amountInput.dispatchEvent(new Event('input', {bubbles:true}));
        haptic();
      });
    });
    document.getElementById("transaction-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!handles) return;
      const selectedCategory = document.getElementById("category").value;
      if (!selectedCategory) { notify("Choose a category first."); return; }
      const amountVal = parseFloat(document.getElementById("amount").value);
      if (!isFinite(amountVal) || amountVal<0) { notify("Enter a valid amount."); return; }
      const tx = {
        type: document.getElementById("type").value,
        category: selectedCategory,
        amount: Number(amountVal.toFixed(2)),
        date: document.getElementById("date").value,
        description: (document.getElementById("description").value || "No description").trim(),
        createdAt: Date.now()
      };
      try {
        await handles.transactionsCol.add(tx);
        e.target.reset(); if (dateEl) dateEl.valueAsDate = new Date(); document.getElementById("type").value='income'; rebuildCategoryOptions();
        notify("Transaction added!"); haptic();
      } catch (err) { console.error(err); notify("Error adding transaction"); }
    });

    // Clear all (danger)
    document.getElementById('clear-btn').addEventListener('click', async ()=>{
      if (!handles) return;
      if (!confirm('Are you sure? This erases EVERYTHING for this household.')) return;
      try{
        const txSnap = await handles.transactionsCol.get();
        const catSnap = await handles.categoriesCol.get();
        const batch = db.batch();
        txSnap.forEach(d=> batch.delete(d.ref));
        catSnap.forEach(d=> batch.delete(d.ref));
        await batch.commit();
        notify('All data cleared.');
      }catch(err){ console.error(err); notify('Error clearing data.'); }
    });

    // Modals: âœ• buttons & backdrop close
    document.querySelectorAll('.close-modal').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetSel = btn.getAttribute('data-close');
        const modal = targetSel ? document.querySelector(targetSel) : btn.closest('.modal');
        if (modal) modal.style.display = 'none';
      });
    });
    window.addEventListener("click", (e)=>{ $$(".modal").forEach(m=>{ if(e.target===m) m.style.display='none'; }) });

    // Copy helpers
    document.getElementById("copy-household").addEventListener("click", async ()=>{
      if (!handles?.id) return; await navigator.clipboard.writeText(handles.id); notify("Household ID copied."); haptic();
    });
    document.getElementById("ensure-invite").addEventListener("click", async ()=>{
      const url = `${BASE_URL}?h=${encodeURIComponent(handles?.id || householdId)}`;
      const input = document.getElementById("invite-url-manage"), copyBtn = document.getElementById("copy-link-manage");
      input.value = url; input.style.display = "inline-block"; copyBtn.style.display = "inline-block";
      copyBtn.onclick = async ()=>{ await navigator.clipboard.writeText(url); notify("Invite link copied!"); haptic(); };
      notify("Invite link ready."); haptic();
    });

    // Keep focused input visible above iPhone keyboard
    document.addEventListener('focusin', (e)=>{
      const el = e.target;
      if (!(el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement || el instanceof HTMLSelectElement)) return;
      setTimeout(()=>{
        const rect = el.getBoundingClientRect();
        if (rect.bottom > window.innerHeight - 90){
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 120);
    });

  })();
  </script>
</body>
</html>
